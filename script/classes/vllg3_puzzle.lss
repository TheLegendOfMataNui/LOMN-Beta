class vllg3_puzzle {
    property parent;
    property cinema;
    property cinema_shown;
    property deadhives;
    property coindoor;
    property coindoortext;
    property coindoortexttimer;
    property showcoindoor;
    property upgradefruit;
    property upgradefruit2;
    property upgradefruit3;
    property upgradefruit_shown;
    property upgradefruit2_shown;
    property upgradefruit3_shown;
    property wirlpool;
    property orientation;
    property golyo;
    property hafu;
    property huki;
    property ally;
    property ahkmou;
    property bour;
    property epena;
    property kamen;
    property kivi;
    property podu;
    property keeper;
    property piatra;
    property ruiropo;
    property bohkaj;
    property pekka;
    property gadjati;
    property rashe;
    property hammeractive;
    property ballactive;
    property diskactive;
    property hutball;
    property ball;
    
    method vllg3_puzzle(param1) {
        this.parent = param1;
        return null;
    }
    
    method initfull() {
        var door_text;
        this.golyo = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vlgr"), 0);
        this.hafu = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl01"), 0);
        this.huki = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl02"), 0);
        this.ally = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl03"), 0);
        this.ahkmou = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl04"), 0);
        this.bour = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl05"), 0);
        this.epena = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl06"), 0);
        this.kamen = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl07"), 0);
        this.kivi = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl08"), 0);
        this.podu = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl09"), 0);
        this.keeper = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl10"), 0);
        this.piatra = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl11"), 0);
        this.ruiropo = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl12"), 0);
        this.bohkaj = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl13"), 0);
        this.pekka =  gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl14"), 0);
        this.gadjati = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl15"), 0);
        this.rashe = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl16"), 0);
        this.hammeractive = 0;
        this.diskactive = 0;
        this.ballactive = 0;
        if (bettersaver::getbooleanvalue(38)) {              
            this.ballactive = 2;
        }
        this.hutball = new lego_moveableobject("kbll");
        this.hutball.initfull();
        this.hutball.hide();
        this.ball = new lego_moveableobject("kbl1");
        this.ball.initfull();
        this.ball.hide();
        gcareadirector::setnearestmax(8);
        gcmodeldirector::setnearestmax(7);
        gcareadirector::setfog(-1, 0 - 20.0, 0 - 600.0, 0.05);
        gclightdirector::setcavelighting(0);
        if (gcsaver::findcinema(scslosifoundation::stringtoidentifier("cin5"))) {
            this.cinema_shown = 1;
        }
        else {
            this.cinema_shown = 0;
        }
        if (this.cinema_shown == 0) {
            this.cinema = gccinemaengine::create();
            gccinemaengine::load(this.cinema, "cin5");
            gccinemaengine::setnextarea(this.cinema, scslosifoundation::stringtoidentifier("tura"));
        }
        this.deadhives = 0;
        if (gcsaver::isconditionset(4194304) == 1) {
            //Set Tohunga: Golyo (VLGR)
            gccharacter::settohunga(this.golyo, rgba(163, 81, 0, 255), rgba(222, 198, 128, 255), scslosifoundation::stringtoidentifier("mk4a"));
            
            //Set Tohunga: Hafu (VL01)
            gccharacter::settohunga(this.hafu, rgba(39, 39, 39, 255), rgba(39, 39, 39, 255), scslosifoundation::stringtoidentifier("mk8a"));
            gccharacter::setorientation(this.hafu, 144);
            gccharacter::setinputstate(this.hafu, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.hafu, scslosifoundation::stringtoidentifier("hak3"), -1);
            
            //Set Tohunga: Huki (VL02)
            gccharacter::settohunga(this.huki, rgba(163, 81, 0, 255), rgba(163, 81, 0, 255), scslosifoundation::stringtoidentifier("mk2a"));
            gccharacter::setorientation(this.huki, 144);
            gccharacter::setinputstate(this.huki, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.huki, scslosifoundation::stringtoidentifier("d000"), -1);
            
            //Set Tohunga: Ally (VL03)
            gccharacter::settohunga(this.ally, rgba(82, 48, 24, 255), rgba(82, 48, 24, 255), scslosifoundation::stringtoidentifier("mk8a"));
            gccharacter::setorientation(this.ally, -89);
            gccharacter::setinputstate(this.ally, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.ally, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.ally, "vl03/sash", 1);
            
            //Set Tohunga: Ahkmou (VL04)
            gccharacter::settohunga(this.ahkmou, rgba(163, 81, 0, 255), rgba(39, 39, 39, 255), scslosifoundation::stringtoidentifier("mk9a"));
            gccharacter::setinputstate(this.ahkmou, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.ahkmou, scslosifoundation::stringtoidentifier("hak3"), -1);
            
            //Set Tohunga: Bour (VL05)
            gccharacter::settohunga(this.bour, rgba(82, 48, 24, 255), rgba(228, 128, 30, 255), scslosifoundation::stringtoidentifier("mk3a"));
            gccharacter::setinputstate(this.bour, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.bour, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(38) == 1) {
                //Set to idle & place item
                gccharacter::switchanimation(this.bour, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.ballactive == 2) {
                    this.hutball.show();
                }
            }
            
            //Set Tohunga: Epena (Vl06)
            gccharacter::settohunga(this.epena, rgba(228, 128, 30, 255), rgba(228, 128, 30, 255), scslosifoundation::stringtoidentifier("mk0a"));
            gccharacter::setorientation(this.epena, 169);
            gccharacter::setinputstate(this.epena, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.epena, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(39) == 1) {
                //Set to idle & add item
                gccharacter::switchanimation(this.epena, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.hammeractive == 0) {
                    gccharacter::addpart(this.epena, "vl06/hamm", 1);
                    this.hammeractive = 1;
                }
            }
            
            //Set Tohunga: Kamen (VL07)
            gccharacter::settohunga(this.kamen, rgba(82, 48, 24, 255), rgba(82, 48, 24, 255), scslosifoundation::stringtoidentifier("mkca"));
            
            //Set Tohunga: Kivi (VL08)
            gccharacter::settohunga(this.kivi, rgba(163, 81, 0, 255), rgba(163, 81, 0, 255), scslosifoundation::stringtoidentifier("mk1a"));
            gccharacter::setinputstate(this.kivi, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.kivi, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(40) == 1) {
                gccharacter::switchanimation(this.kivi, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.diskactive == 0) {
                    gccharacter::addpart(this.kivi, "vl08/sash", 1);
                    this.diskactive = 1;
                }
            }
            
            //Set Tohunga: Podu (VL09)
            gccharacter::settohunga(this.podu, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk7a"));
            gccharacter::setinputstate(this.podu, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.podu, scslosifoundation::stringtoidentifier("hak3"), -1);
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl09"), 0), rgba(222, 198, 128, 255), rgba(39, 39, 39, 255), rgba(163, 81, 0, 255));
            
            //Set Tohunga: Treekeeper (VL10)
            gccharacter::settohunga(this.keeper, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk4a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl10"), 0), rgba(0, 208, 33, 255), rgba(0, 208, 33, 255), rgba(102, 0, 102, 255));
            gccharacter::setorientation(this.keeper, -117);
            gccharacter::setinputstate(this.keeper, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.keeper, scslosifoundation::stringtoidentifier("d000"), -1);
            
            //Set Tohunga: Piatra (VL11)
            gccharacter::settohunga(this.piatra, rgba(222, 198, 128, 255), rgba(39, 39, 39, 255), scslosifoundation::stringtoidentifier("mkba"));
            gccharacter::setorientation(this.piatra, -41);
            gccharacter::setinputstate(this.piatra, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.piatra, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.piatra, "vl11/sash", 1);
            
            //Set Tohunga: Ruiropo (VL12)
            gccharacter::settohunga(this.ruiropo, rgba(39, 39, 39, 255), rgba(39, 39, 39, 255), scslosifoundation::stringtoidentifier("mk6a"));
            gccharacter::setorientation(this.ruiropo, -141);
            gccharacter::setinputstate(this.ruiropo, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.ruiropo, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.ruiropo, "vl12/sash", 1);
            
            //Set Tohunga: Bohkaj (VL13)
            gccharacter::settohunga(this.bohkaj, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mkaa"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl13"), 0), rgba(228, 128, 30, 255), rgba(228, 128, 30, 255), rgba(163, 81, 0, 255));
            gccharacter::setorientation(this.bohkaj, 159);
            gccharacter::setinputstate(this.bohkaj, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.bohkaj, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.bohkaj, "vl13/sash", 1);
            
            //Set Tohunga: Pekka (VL14)
            gccharacter::settohunga(this.pekka, rgba(228, 128, 30, 255), rgba(228, 128, 30, 255), scslosifoundation::stringtoidentifier("mk6a"));
            
            //Set Tohunga: Gadjati (VL15)
            gccharacter::settohunga(this.gadjati, rgba(228, 128, 30, 255), rgba(228, 128, 30, 255), scslosifoundation::stringtoidentifier("mk9a"));
            
            //Set Tohunga: Rashe (VL16)
            gccharacter::settohunga(this.rashe, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk8a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl16"), 0), rgba(39, 39, 39, 255), rgba(222, 198, 128, 255), rgba(82, 48, 24, 255));
            
			//Set Rahi: Blue Scorpion
			gcmodeldirector::show(scslosifoundation::stringtoidentifier("blsc"), 0);
			
            //Hiding hives & Turaga door            
            gcareadirector::hide(scslosifoundation::stringtoidentifier("ghv0"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("ghv1"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("ghv2"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("fhv0"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("drs2"), scslosifoundation::stringtoidentifier("vllg"));
            globalclass.bgmusic.changefilename("Root/Data/sounds/MusicVillage");
            globalclass.bgmusic.play(1);
        }
        else {
            //Hiding Characters
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vlgr"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl01"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl02"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl03"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl04"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl05"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl06"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl07"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl08"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl09"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl10"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl11"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl12"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl13"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl14"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl15"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl16"), 0);
			gcmodeldirector::hide(scslosifoundation::stringtoidentifier("blsc"), 0);
            globalclass.bgmusic.changefilename("Root/Data/sounds/MusicPohatuTheme");
            globalclass.bgmusic.play(1);
        }
        this.coindoor = new lego_moveableobject("door", "vllg");
        this.coindoor.initfull();
        if (bettersaver::getbooleanvalue(54) == 0) {
            this.showcoindoor = 1;
            this.coindoor.show();
            this.coindoor.setalpha(0.5);
        }
        else {
            this.coindoor.hide();
        }
        door_text = gcareadirector::getscriptfluffstringuint(scslosifoundation::stringtoidentifier("door"), 1, 0, 10);
        this.coindoortext = new gs_legotext("Root/Data/Art/Fonts/BionicleFontHi", door_text, screenx * 0.5, screeny * 0.83, 0, 1.5, 256, 4, 0);
        this.coindoortext.initfull();
        this.coindoortext.add();
        this.coindoortexttimer = 0.0;
        this.upgradefruit_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("frut"));
        if (this.upgradefruit_shown == 0) {
            this.upgradefruit = new lego_pickup("frut", 0, 6, "frut", 1, 1);
            this.upgradefruit.initfull();
        }
        this.upgradefruit2_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("fru0"));
        if (this.upgradefruit2_shown == 0) {
            this.upgradefruit2 = new lego_pickup("fru0", 0, 6, "frut", 1, 1);
            this.upgradefruit2.initfull();
        }
        this.upgradefruit3_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("fru1"));
        if (this.upgradefruit3_shown == 0) {
            this.upgradefruit3 = new lego_pickup("fru1", 0, 6, "frut", 1, 1);
            this.upgradefruit3.initfull();
        }
        if (bettersaver::getbooleanvalue(60) == 1) {
            gccollisionphysicsgroup::togglepickuponoff(scslosifoundation::stringtoidentifier("ar00"), 0);
            gcnolightdirector::hide(scslosifoundation::stringtoidentifier("ar00"), gcareadirector::getcurrentarea());
        }
        this.wirlpool = new lego_moveableobject("vtcr");
        this.wirlpool.initfull();
        this.wirlpool.settweakable();
        this.orientation = 1;
        return null;
    }
    
    method cleanupfull() {
        if (this.coindoortext != null) {
            this.coindoortext.remove();
            this.coindoortext.cleanupfull();
            this.coindoortext = null;
        }
        if (this.coindoor != null) {
            this.coindoor.cleanupfull();
            this.coindoor = null;
        }
        if (this.upgradefruit != null) {
            this.upgradefruit.cleanupfull();
            this.upgradefruit = null;
        }
        if (this.upgradefruit2 != null) {
            this.upgradefruit2.cleanupfull();
            this.upgradefruit2 = null;
        }
        if (this.upgradefruit3 != null) {
            this.upgradefruit3.cleanupfull();
            this.upgradefruit3 = null;
        }
        if (this.wirlpool != null) {
            this.wirlpool.cleanupfull();
            this.wirlpool = null;
        }
        this.cinema = null;
        this.golyo = null;
        this.hafu = null;
        this.huki = null;
        this.ally = null;
        this.ahkmou = null;
        this.bour = null;
        this.epena = null;
        this.kamen = null;
        this.kivi = null;
        this.podu = null;
        this.keeper = null;
        this.piatra = null;
        this.ruiropo = null;
        this.bohkaj = null;
        this.pekka =  null;
        this.gadjati = null;
        this.rashe = null;
        this.hammeractive = null;
        this.diskactive = null;
        this.ballactive = null;
        this.hutball = null;
        this.ball = null;
        return null;
    }
    
    method exit() {
        this.parent = null;
        return null;
    }
    
    method process(param1) {
        this.rotatecrystal();
        if (this.coindoortexttimer > 0) {
            this.coindoortexttimer = this.coindoortexttimer - param1.deltatime;
        }
        else if (this.coindoortext.onscreen == 1) {
            this.coindoortext.hide();
        }
        return null;
    }
    
    method onevent(param1) {
        if (param1.eventid == 46) {
            gccollisionphysicsgroup::spinmask(1.2);
        }
        else if (param1.eventid == 27) {
            globalclass.level.cam.setaimode(11);
            globalclass.player.actor.gotopos(this.parent.enterstartid, this.parent.enterlookid);
            globalclass.player.unkill();
            globalclass.player.actor.switchanimation(scslosifoundation::stringtoidentifier("p000"));
            globalclass.player.actor.setinputstate("ninp");
        }
        else if (param1.eventid == 51) {
            if (param1.args[1] == 1) {
                this.deadhives = this.deadhives + 1;
                if (this.deadhives == 4) {
                    gcsaver::setcondition(4194304, 1);
                    gcareadirector::hide(scslosifoundation::stringtoidentifier("drs2"), scslosifoundation::stringtoidentifier("vllg"));
                    globalclass.bgmusic.changefilename("Root/Data/sounds/MusicVillage");
                    globalclass.bgmusic.play(1);
                }
            }
        }
        else if (param1.eventid == 35) {
            if (param1.args[0] == scslosifoundation::stringtoidentifier("door")) {
                bettersaver::setbooleanvalue(54, 1);
                this.coindoor.hide();
            }
        }
        else if (param1.eventid == 41) {
            if (bettersaver::getbooleanvalue(38)) {
                //Bour Quest Complete
                if (this.upgradefruit2_shown == 0) {
                    this.upgradefruit2.obj.setpos(-488.2388, -27.89344, -282.2012);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit2_shown = 1;
                }
                if (this.ballactive == 0) {
                    this.ball.show();
                    this.ballactive = 1;  
                }
            }
            if (bettersaver::getbooleanvalue(39)) {
                //Epena Quest Complete
                if (this.upgradefruit_shown == 0) {
                    this.upgradefruit.obj.setpos(-402.0996, -10.13396, -315.395);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit_shown = 1;
                }
                if (this.hammeractive == 0) {
                    gccharacter::addpart(this.epena, "vl06/hamm", 1);
                    this.hammeractive = 1;
                }
            }
            if (bettersaver::getbooleanvalue(40)) {
                //Kivi Quest Complete
                if (this.upgradefruit3_shown == 0) {
                    this.upgradefruit3.obj.setpos(-322.5265, -27.89493, -284.7898);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit3_shown = 1;
                }
                if (this.diskactive == 0) {
                    gccharacter::addpart(this.kivi, "vl08/sash", 1);
                    this.diskactive = 1;
                }
            }
        }
        else if (param1.eventid == 4) {
            if ((param1.args[0] == scslosifoundation::stringtoidentifier("cin5")) && (this.cinema_shown == 0)) {
                if (((gcsaver::isconditionset(1) && gcsaver::isconditionset(2)) && gcsaver::isconditionset(4)) && gcsaver::isconditionset(8)) {
                    gccinemaengine::play(this.cinema);
                    //Remove Tohunga hand items
                    if (this.hammeractive == 1) {
                        gccharacter::removepart(this.epena, 1);
                    }
                    this.cinema_shown = 1;
                    if (globalclass.player.maskcontrol.isactive()) {
                            globalclass.player.maskcontrol.toggleactive();
                            globalclass.hud.mask.hide();
                    }
                }
            }
        }
        else if (param1.eventid == 30) {
            globalclass.bgmusic.stop();
        }
        else if (param1.eventid == 1) {
            if (param1.args[1] == scslosifoundation::stringtoidentifier("door")) {
                if (this.showcoindoor == 1) {
                    if ((globalclass.player.tokens >= 10) && (gcsaver::isconditionset(4194304))) {
                        this.coindoor.fadeout(1.5);
                        gcstaticsoundsptrarray::playtablesound(1084);
                        this.showcoindoor = 0;
                        this.coindoortext.hide();
                    }
                    else {
                        this.coindoortext.show();
                        this.coindoortexttimer = 1.0;
                    }
                }
            }
        }
        return null;
    }
    
    method input(param1) {
        if ((param1.event == 2) && (param1.button == 251)) {
            if (this.cinema != null) {
                gccinemaengine::stop(this.cinema);
            }
        }
        return null;
    }
    
    method rotatecrystal() {
        if (this.orientation > 359) {
            this.orientation = 0;
        }
        else {
            this.orientation = this.orientation + 1;
        }
        this.wirlpool.setorientation(0.0, this.orientation, 0.0);
        return null;
    }
}