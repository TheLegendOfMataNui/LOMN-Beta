class vllg4_puzzle {
    property parent;
    property cinema;
    property cinema_shown;
    property deadhives;
    property savedrahi;
    property taskcomplete;
    property coindoor;
    property coindoortext;
    property coindoortexttimer;
    property showcoindoor;
    property upgradefruit;
    property upgradefruit2;
    property upgradefruit3;
    property upgradefruit_shown;
    property upgradefruit2_shown;
    property upgradefruit3_shown;
    property crystal;
    property orientation;
    property keeper;
    property matoro;
    property kantai;
    property kopeke;
    property ehrye;
    property lumi;
    property jaatikko;
    property kokkan;
    property toudo;
    property zaskra;
    property pakastaa;
    property talvi;
    property jaa;
    property arktienen;
    property kylma;
    property nykto;
    property monadri;
    property odda;
    property volma;
    property skateactive;
    property elementactive;
    property diskactive;
    property hutelement;
    property start_cinema;
    property safety_timer;
    
    method vllg4_puzzle(param1) {
        this.parent = param1;
        return null;
    }
    
    method initfull() {
        gcmodeldirector::setnearestmax(5);
        gcareadirector::setnearestmax(8);
        gcareadirector::setfog(-16777200, 0 - 1.0, 0 - 900.0, 0.15);
        gclightdirector::setcavelighting(0);
        this.keeper = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vlgr"), 0);
        this.matoro = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl01"), 0);
        this.kantai = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl02"), 0);
        this.kopeke = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl03"), 0);
        this.ehrye = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl04"), 0);
        this.lumi = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl05"), 0);
        this.jaatikko = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl06"), 0);
        this.kokkan = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl07"), 0);
        this.toudo = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl08"), 0);
        this.zaskra = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl09"), 0);
        this.pakastaa = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl10"), 0);
        this.talvi = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl11"), 0);
        this.jaa = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl12"), 0);
        this.arktienen = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl13"), 0);
        this.kylma = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl14"), 0);
        this.nykto = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl15"), 0);
        this.monadri = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl16"), 0);
        this.odda = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl17"), 0);
        this.volma = gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl18"), 0);
        this.skateactive = 0;
        this.elementactive = 0;
        this.diskactive = 0;
        if (bettersaver::getbooleanvalue(42)) {              
            this.elementactive = 2;
        }
        this.hutelement = new lego_moveableobject("crst");
        this.hutelement.initfull();
        this.hutelement.hide();
        if (gcsaver::findcinema(scslosifoundation::stringtoidentifier("cin3"))) {
            this.cinema_shown = 1;
        }
        else {
            this.cinema_shown = 0;
        }
        if (this.cinema_shown == 0) {
            this.cinema = gccinemaengine::create();
            gccinemaengine::load(this.cinema, "cin3");
            gccinemaengine::setnextarea(this.cinema, scslosifoundation::stringtoidentifier("tura"));
        }
        this.deadhives = 0;
        this.savedrahi = 0;
        this.taskcomplete = 0;
        if (gcsaver::isconditionset(4194304) == 1) {
            globalclass.player.processequipment(2);           
            //Set Tohunga: Treekeeper (VLGR)
            gccharacter::settohunga(this.keeper, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk4a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vlgr"), 0), rgba(0, 208, 33, 255), rgba(0, 208, 33, 255), rgba(102, 0, 102, 255));
            gccharacter::setorientation(this.keeper, -73);
            gccharacter::setinputstate(this.keeper, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.keeper, scslosifoundation::stringtoidentifier("d000"), -1);
            
            //Set Tohunga: Matoro (VL01)
            gccharacter::settohunga(this.matoro, rgba(131, 141, 181, 255), rgba(131, 141, 181, 255), scslosifoundation::stringtoidentifier("mk3a"));
            gccharacter::setorientation(this.matoro, 113);
            gccharacter::setinputstate(this.matoro, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.matoro, scslosifoundation::stringtoidentifier("d000"), -1);
            
            //Set Tohunga: Kantai (VL02)
            gccharacter::settohunga(this.kantai, rgba(255, 255, 255, 255), rgba(255, 255, 255, 255), scslosifoundation::stringtoidentifier("mkba"));
            gccharacter::setorientation(this.kantai, -94);
            gccharacter::setinputstate(this.kantai, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.kantai, scslosifoundation::stringtoidentifier("hak4"), -1);
            
            //Set Tohunga: Kopeke (VL03)
            gccharacter::settohunga(this.kopeke, rgba(131, 141, 181, 255), rgba(131, 141, 181, 255), scslosifoundation::stringtoidentifier("mkaa"));
            gccharacter::setorientation(this.kopeke, 93);
            gccharacter::setinputstate(this.kopeke, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.kopeke, scslosifoundation::stringtoidentifier("hak4"), -1);
            
            //Set Tohunga: Ehrye (VL04)
            gccharacter::settohunga(this.ehrye, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mkca"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl04"), 0), rgba(255, 255, 255, 255), rgba(255, 255, 255, 255), rgba(115, 117, 115, 255));
            gccharacter::setorientation(this.ehrye, 54);
            gccharacter::setinputstate(this.ehrye, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.ehrye, scslosifoundation::stringtoidentifier("hak4"), -1);
            
            //Set Tohunga: Lumi (VL05)
            gccharacter::settohunga(this.lumi, rgba(195, 195, 195, 255), rgba(195, 195, 195, 255), scslosifoundation::stringtoidentifier("mk6a"));
            gccharacter::setorientation(this.lumi, -18);
            gccharacter::setinputstate(this.lumi, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.lumi, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(41) == 1) {          
                //Set to idle & add item
                gccharacter::switchanimation(this.lumi, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.diskactive == 0) {
                    gccharacter::addpart(this.lumi, "vl05/sash", 1);
                    this.diskactive = 1;
                }
            }
            
            //Set Tohunga: Jaatikko (VL06)
            gccharacter::settohunga(this.jaatikko, rgba(122, 254, 255, 255), rgba(122, 254, 255, 255), scslosifoundation::stringtoidentifier("mk0a"));
            gccharacter::setorientation(this.jaatikko, 16);
            gccharacter::setinputstate(this.jaatikko, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.jaatikko, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(42) == 1) {          
                //Set to idle & place item              
                gccharacter::switchanimation(this.jaatikko, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.elementactive == 2) {
                    this.hutelement.show();
                }
            }
            
            //Set Tohunga: Kokkan (VL07)
            gccharacter::settohunga(this.kokkan, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk2a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl07"), 0), rgba(255, 255, 255, 255), rgba(255, 255, 255, 255), rgba(195, 195, 195, 255));
            gccharacter::setorientation(this.kokkan, -154);
            gccharacter::setinputstate(this.kokkan, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.kokkan, scslosifoundation::stringtoidentifier("d003"), -1);
            if (bettersaver::getbooleanvalue(43) == 1) {          
                //Set to idle & add item
                gccharacter::switchanimation(this.kokkan, scslosifoundation::stringtoidentifier("d000"), -1);
                if (this.skateactive == 0) {
                    gccharacter::addpart(this.kokkan, "vl07/sktb", 1);
                    gccharacter::setgroundoffset(this.kokkan, 0.5);
                    this.skateactive = 1;
                }
            }
            
            //Set Tohunga: Toudo (VL08)
            gccharacter::settohunga(this.toudo, rgba(39, 38, 39, 255), rgba(122, 254, 255, 255), scslosifoundation::stringtoidentifier("mk9a"));
            gccharacter::setorientation(this.toudo, -29);
            gccharacter::setinputstate(this.toudo, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.toudo, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.toudo, "vl08/sash", 1);
            gccharacter::addpart(this.toudo, "vl08/icpk", 2);
            
            //Set Tohunga: Zaskra (VL09)
            gccharacter::settohunga(this.zaskra, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk1a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl09"), 0), rgba(255, 255, 255, 255), rgba(131, 141, 181, 255), rgba(195, 195, 195, 255));
            gccharacter::setorientation(this.zaskra, -60);
            gccharacter::setinputstate(this.zaskra, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.zaskra, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.zaskra, "vl09/sash", 1);
            gccharacter::addpart(this.zaskra, "vl09/icpk", 2);
            
            //Set Tohunga: Pakastaa (VL10)
            gccharacter::settohunga(this.pakastaa, rgba(39, 38, 39, 255), rgba(39, 38, 39, 255), scslosifoundation::stringtoidentifier("mk7a"));
            gccharacter::setorientation(this.pakastaa, 98);
            gccharacter::setinputstate(this.pakastaa, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.pakastaa, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.pakastaa, "vl10/sash", 1);
            gccharacter::addpart(this.pakastaa, "vl10/icpk", 2);
            
            //Set Tohunga: Talvi (VL11)
            gccharacter::settohunga(this.talvi, rgba(39, 38, 39, 255), rgba(39, 38, 39, 255), scslosifoundation::stringtoidentifier("mk2a"));
            gccharacter::setorientation(this.talvi, 58);
            gccharacter::setinputstate(this.talvi, scslosifoundation::stringtoidentifier("none"));
            gccharacter::switchanimation(this.talvi, scslosifoundation::stringtoidentifier("d000"), -1);
            gccharacter::addpart(this.talvi, "vl11/sash", 1);
            gccharacter::addpart(this.talvi, "vl11/icpk", 2);
            
            //Set Tohunga: Jaa (VL12)
            gccharacter::settohunga(this.jaa, rgba(195, 195, 195, 255), rgba(195, 195, 195, 255), scslosifoundation::stringtoidentifier("mk8a"));
            
            //Set Tohunga: Arktienen (VL13)
            gccharacter::settohunga(this.arktienen, rgba(179, 194, 199, 255), rgba(122, 254, 255, 255), scslosifoundation::stringtoidentifier("mkca"));
            
            //Set Tohunga: Kylma (VL14)
            gccharacter::settohunga(this.kylma, rgba(195, 195, 195, 255), rgba(195, 195, 195, 255), scslosifoundation::stringtoidentifier("mk4a"));
            
            //Set Tohunga: Nykto (VL15)
            gccharacter::settohunga(this.nykto, rgba(195, 195, 195, 255), rgba(39, 38, 39, 255), scslosifoundation::stringtoidentifier("mkba"));
            
            //Set Tohunga: Monadri (VL16)
            gccharacter::settohunga(this.monadri, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mk7a"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl16"), 0), rgba(131, 141, 181, 255), rgba(131, 141, 181, 255), rgba(122, 254, 255, 255));
            
            //Set Tohunga: Odda (VL17)
            gccharacter::settohunga(this.odda, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), scslosifoundation::stringtoidentifier("mkba"));
            gccharacter::setcolors(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("vl17"), 0), rgba(122, 254, 255, 255), rgba(122, 254, 255, 255), rgba(131, 141, 181, 255));
            
            //Set Tohunga: Volma (VL18)
            gccharacter::settohunga(this.volma, rgba(255, 255, 255, 255), rgba(122, 254, 255, 255), scslosifoundation::stringtoidentifier("mk0a"));

            //Set Rahi: Blue Bat
			gcmodeldirector::show(scslosifoundation::stringtoidentifier("bbat"), 0);
            gccharacter::setgroundoffset(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("bbat")), 2);
            gccharacter::aidisabledefault(gcmodeldirector::getcharacter(scslosifoundation::stringtoidentifier("bbat")));

            //Hiding hives & Turaga door
            gcareadirector::hide(scslosifoundation::stringtoidentifier("dor2"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("ghv0"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("ghv1"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("fhv0"), scslosifoundation::stringtoidentifier("vllg"));
            gcareadirector::hide(scslosifoundation::stringtoidentifier("fhv1"), scslosifoundation::stringtoidentifier("vllg"));
            globalclass.bgmusic.changefilename("Root/Data/sounds/MusicVillage");
            globalclass.bgmusic.play(1);
        }
        else {
            //Hiding Characters
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vlgr"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl01"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl02"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl03"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl04"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl05"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl06"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl07"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl08"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl09"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl10"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl11"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl12"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl13"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl14"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl15"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl16"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl17"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("vl18"), 0);
            gcmodeldirector::hide(scslosifoundation::stringtoidentifier("bbat"), 0);
            globalclass.bgmusic.changefilename("Root/Data/Sounds/MUSICKopakaTheme");
            globalclass.bgmusic.play(1);
        }
        this.coindoor = new lego_moveableobject("door");
        this.coindoor.initfull();
        if (bettersaver::getbooleanvalue(55) == 0) {
            this.showcoindoor = 1;
            this.coindoor.show();
            this.coindoor.setalpha(0.6);
        }
        else {
            this.coindoor.hide();
        }
        this.coindoortext = new gs_legotext("Root/Data/Art/Fonts/BionicleFontHi", gcareadirector::getscriptfluffstring(scslosifoundation::stringtoidentifier("door"), 1, 0) + "15 " + gcareadirector::getscriptfluffstring(scslosifoundation::stringtoidentifier("door"), 1, 4), screenx * 0.5, screeny * 0.70, 0, 1.5, 256, 4, 0);
        this.coindoortext.initfull();
        this.coindoortext.add();
        this.coindoortexttimer = 0.0;
        this.upgradefruit_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("frut"));
        if (this.upgradefruit_shown == 0) {
            this.upgradefruit = new lego_pickup("frut", 0, 6, "frut", 1, 1);
            this.upgradefruit.initfull();
        }
        this.upgradefruit2_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("fru0"));
        if (this.upgradefruit2_shown == 0) {
            this.upgradefruit2 = new lego_pickup("fru0", 0, 6, "frut", 1, 1);
            this.upgradefruit2.initfull();
        }
        this.upgradefruit3_shown = gcsaver::finditem(scslosifoundation::stringtoidentifier("fru1"));
        if (this.upgradefruit3_shown == 0) {
            this.upgradefruit3 = new lego_pickup("fru1", 0, 6, "frut", 1, 1);
            this.upgradefruit3.initfull();
        }
        if (bettersaver::getbooleanvalue(61) == 1) {
            gccollisionphysicsgroup::togglepickuponoff(scslosifoundation::stringtoidentifier("ar00"), 0);
            gcnolightdirector::hide(scslosifoundation::stringtoidentifier("ar00"), gcareadirector::getcurrentarea());
        }
        this.crystal = new lego_moveableobject("vtcr");
        this.crystal.initfull();
        this.crystal.settweakable();
        this.orientation = 1;
        this.safety_timer = 0;
        return null;
    }
    
    method cleanupfull() {
        if (this.coindoortext != null) {
            this.coindoortext.remove();
            this.coindoortext.cleanupfull();
            this.coindoortext = null;
        }
        if (this.coindoor != null) {
            this.coindoor.cleanupfull();
            this.coindoor = null;
        }
        if (this.upgradefruit != null) {
            this.upgradefruit.cleanupfull();
            this.upgradefruit = null;
        }
        if (this.upgradefruit2 != null) {
            this.upgradefruit2.cleanupfull();
            this.upgradefruit2 = null;
        }
        if (this.upgradefruit3 != null) {
            this.upgradefruit3.cleanupfull();
            this.upgradefruit3 = null;
        }
        if (this.crystal != null) {
            this.crystal.cleanupfull();
            this.crystal = null;
        }
        this.cinema = null;
        this.cinema_shown = null;
        this.deadhives = null;
        this.savedrahi = null;
        this.taskcomplete = null;
        this.coindoortexttimer = null;
        this.showcoindoor = null;
        this.upgradefruit_shown = null;
        this.upgradefruit2_shown = null;
        this.upgradefruit3_shown = null;
        this.orientation = null;
        this.keeper = null;
        this.matoro = null;
        this.kantai = null;
        this.kopeke = null;
        this.ehrye = null;
        this.lumi = null;
        this.jaatikko = null;
        this.kokkan = null;
        this.toudo = null;
        this.zaskra = null;
        this.pakastaa = null;
        this.talvi = null;
        this.jaa = null;
        this.arktienen = null;
        this.kylma = null;
        this.nykto = null;
        this.monadri = null;
        this.odda = null;
        this.volma = null;
        this.skateactive = null;
        this.elementactive = null;
        this.diskactive = null;
        this.hutelement = null;
        this.start_cinema = null;
        this.safety_timer = null;
        return null;
    }
    
    method process(param1) {
        this.rotatecrystal();
        if (this.coindoortexttimer > 0) {
            this.coindoortexttimer = this.coindoortexttimer - param1.deltatime;
        }
        else if (this.coindoortext.onscreen == 1) {
            this.coindoortext.hide();
        }
        if (this.start_cinema == 1) {
            if (this.safety_timer > 0.01) {
                this.start_cinema = 0;            
            }
            else {
                this.safety_timer = this.safety_timer + param1.deltatime;
            }
        }
        return null;
    }
    
    method onevent(param1) {
        if (param1.eventid == 51) {
            this.deadhives = this.deadhives + 1;
        }
        else if (param1.eventid == 101) {
            this.savedrahi = this.savedrahi + 1;
        }        
        else if (param1.eventid == 44) {
            if ((this.deadhives == 4) && (this.savedrahi == 4) && (this.taskcomplete == 0)) {
                gcsaver::setcondition(4194304, 1);
                gcareadirector::hide(scslosifoundation::stringtoidentifier("dor2"), scslosifoundation::stringtoidentifier("vllg"));
                globalclass.bgmusic.stop();
                this.taskcomplete = 1;
            }
        }
        else if (param1.eventid == 1) {
            if (param1.args[1] == scslosifoundation::stringtoidentifier("door")) {
                if (this.showcoindoor == 1) {
                    if ((globalclass.player.tokens >= 15) && (gcsaver::isconditionset(4194304))) {
                        this.coindoor.fadeout(1.5);
                        gcstaticsoundsptrarray::playtablesound(1084);
                        this.showcoindoor = 0;
                        this.coindoortext.hide();
                    }
                    else {
                        this.coindoortext.show();
                        this.coindoortexttimer = 1.0;
                    }
                }
            }
        }
        else if (param1.eventid == 35) {
            if (param1.args[0] == scslosifoundation::stringtoidentifier("door")) {
                bettersaver::setbooleanvalue(55, 1);
                this.coindoor.hide();
            }
        }
        else if (param1.eventid == 41) {
            if (bettersaver::getbooleanvalue(41)) {
                //Lumi Quest Complete
                if (this.upgradefruit_shown == 0) {
                    this.upgradefruit.obj.setpos(87.80151, -4.62647, -59.99429);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit_shown = 1;
                }
                if (this.diskactive == 0) {
                    gccharacter::addpart(this.lumi, "vl05/sash", 1);
                    this.diskactive = 1;
                }
            }
            if (bettersaver::getbooleanvalue(42)) {
                //Jaatikko Quest Complete
                if (this.upgradefruit2_shown == 0) {
                    this.upgradefruit2.obj.setpos(5.932235, 2.761841, -47.96942);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit2_shown = 1;
                }
                if (this.elementactive == 0) {
                    gccharacter::addpart(this.jaatikko, "vl06/crst", 1);
                    this.elementactive = 1;
                }
            }
            if (bettersaver::getbooleanvalue(43)) {
                //Kokkan Quest Complete
                if (this.upgradefruit3_shown == 0) {
                    this.upgradefruit3.obj.setpos(56.16686, -22.91752, 55.69683);
                    gcstaticsoundsptrarray::playtablesound(1032);
                    this.upgradefruit3_shown = 1;
                }
                if (this.skateactive == 0) {
                    gccharacter::addpart(this.kokkan, "vl07/sktb", 1);
                    gccharacter::setgroundoffset(this.kokkan, 0.5);
                    this.skateactive = 1;
                }
            }
        }
        else if (param1.eventid == 4) {
            if ((param1.args[0] == scslosifoundation::stringtoidentifier("cin3")) && (this.cinema_shown == 0)) {
                if (((gcsaver::isconditionset(1) && gcsaver::isconditionset(2)) && gcsaver::isconditionset(4)) && gcsaver::isconditionset(8)) {
                    this.start_cinema = 1;                
                    globalclass.level.cam.setaimode(0);
                    globalclass.player.actor.physicson(0);
                    globalclass.player.actor.idle();
                    globalclass.player.actor.deactivatedragger();
                    if ((globalclass.player.actor.isdraggeractive() == 0) && (this.safety_timer > 0.01)) {
                        gccinemaengine::play(this.cinema);
                        //Remove Tohunga hand/foot items
                        if (this.skateactive == 1) {
                            gccharacter::removepart(this.kokkan, 1);
                        }
                        if (this.elementactive == 1) {
                            gccharacter::removepart(this.jaatikko, 1);
                        }
                        gccharacter::removepart(this.zaskra, 2);
                        gccharacter::removepart(this.toudo, 2);
                        gccharacter::removepart(this.pakastaa, 2);
                        gccharacter::removepart(this.talvi, 2);
                        this.cinema_shown = 1;
                        if (globalclass.player.maskcontrol.isactive()) {
                            globalclass.player.maskcontrol.toggleactive();
                            globalclass.hud.mask.hide();
                        }
                    }
                }
            }
        }
        else if (param1.eventid == 27) {
            globalclass.level.cam.setaimode(11);
            globalclass.player.actor.gotopos(this.parent.enterstartid, this.parent.enterlookid);
            globalclass.player.unkill();
            globalclass.player.actor.switchanimation(scslosifoundation::stringtoidentifier("k000"));
            globalclass.player.actor.setinputstate("ninp");
        }
        else if (param1.eventid == 30) {
            globalclass.bgmusic.stop();
            globalclass.hud.hide();
        }
        return null;
    }
    
    method input(param1) {
        if (param1.event == 2) {
            if (param1.button == 251) {
                if (this.cinema != null) {
                    gccinemaengine::stop(this.cinema);
                }
            }
        }
        return null;
    }
    
    method exit() {
        this.parent = null;
        return null;
    }
    
    method rotatecrystal() {
        if (this.orientation > 359) {
            this.orientation = 0;
        }
        else {
            this.orientation = this.orientation + 1;
        }
        this.crystal.setorientation(0.0, this.orientation, 0.0);
        return null;
    }
}